#!/bin/bash

# Script Completo de Deploy Autom√°tico - Siqueira Campos Im√≥veis
# Este script configura TUDO automaticamente no servidor

set -e

# Cores para output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
NC='\033[0m'

log_info() {
    echo -e "${BLUE}‚ÑπÔ∏è  $1${NC}"
}

log_success() {
    echo -e "${GREEN}‚úÖ $1${NC}"
}

log_warning() {
    echo -e "${YELLOW}‚ö†Ô∏è  $1${NC}"
}

log_error() {
    echo -e "${RED}‚ùå $1${NC}"
}

log_title() {
    echo -e "${PURPLE}üöÄ $1${NC}"
}

# Banner
clear
echo -e "${PURPLE}"
cat << 'EOF'
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë                 SIQUEIRA CAMPOS IM√ìVEIS                      ‚ïë
‚ïë              Setup Autom√°tico do Servidor                   ‚ïë
‚ïë                                                              ‚ïë
‚ïë  ‚úÖ Corrige problema mobile                                  ‚ïë
‚ïë  ‚úÖ Configura redirect WWW                                   ‚ïë
‚ïë  ‚úÖ Instala auto-deploy                                      ‚ïë
‚ïë  ‚úÖ Configura tudo automaticamente                          ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
EOF
echo -e "${NC}"

# Verificar se √© root
if [[ $EUID -ne 0 ]]; then
   log_error "Este script deve ser executado como root (sudo)"
   exit 1
fi

# Detectar sistema operacional
if [[ -f /etc/os-release ]]; then
    . /etc/os-release
    OS=$ID
    VER=$VERSION_ID
else
    log_error "Sistema operacional n√£o suportado"
    exit 1
fi

log_title "DETECTANDO SISTEMA"
log_info "Sistema: $OS $VER"

# Configura√ß√µes
DOMAIN=""
EMAIL=""
GITHUB_REPO="https://github.com/Nakahh/site-jurez-2.0.git"
PROJECT_DIR="/var/www/siqueira-campos"
NGINX_CONFIG="/etc/nginx/sites-available/siqueira-campos"
NGINX_ENABLED="/etc/nginx/sites-enabled/siqueira-campos"
SERVICE_NAME="siqueira-campos"

# Perguntar configura√ß√µes
echo ""
log_title "CONFIGURA√á√ïES INICIAIS"
read -p "üåê Digite seu dom√≠nio (ex: siqueicamposimoveis.com.br): " DOMAIN
read -p "üìß Digite seu email para SSL (ex: admin@$DOMAIN): " EMAIL

if [ -z "$DOMAIN" ] || [ -z "$EMAIL" ]; then
    log_error "Dom√≠nio e email s√£o obrigat√≥rios!"
    exit 1
fi

# Gerar webhook secret
WEBHOOK_SECRET=$(openssl rand -hex 32)

log_success "Configura√ß√µes definidas:"
log_info "Dom√≠nio: $DOMAIN"
log_info "Email: $EMAIL" 
log_info "Webhook Secret: $WEBHOOK_SECRET"

echo ""
read -p "ü§î Confirma as configura√ß√µes? (y/n): " -n 1 -r
echo
if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    log_error "Configura√ß√£o cancelada"
    exit 1
fi

# Fun√ß√£o para instalar pacotes
install_packages() {
    log_title "INSTALANDO DEPEND√äNCIAS"
    
    # Atualizar reposit√≥rios
    log_info "Atualizando reposit√≥rios..."
    apt update -qq

    # Instalar pacotes essenciais
    log_info "Instalando pacotes b√°sicos..."
    apt install -y curl wget git unzip nginx certbot python3-certbot-nginx \
        software-properties-common apt-transport-https ca-certificates \
        gnupg lsb-release supervisor ufw fail2ban htop

    log_success "Pacotes b√°sicos instalados"
}

# Fun√ß√£o para instalar Docker
install_docker() {
    log_title "INSTALANDO DOCKER"
    
    if command -v docker &> /dev/null; then
        log_info "Docker j√° instalado: $(docker --version)"
        return
    fi

    # Adicionar reposit√≥rio Docker
    curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
    echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null

    # Instalar Docker
    apt update -qq
    apt install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin

    # Configurar Docker
    systemctl enable docker
    systemctl start docker
    usermod -aG docker www-data

    log_success "Docker instalado: $(docker --version)"
}

# Fun√ß√£o para instalar Node.js
install_nodejs() {
    log_title "INSTALANDO NODE.JS"
    
    if command -v node &> /dev/null; then
        log_info "Node.js j√° instalado: $(node --version)"
        return
    fi

    # Instalar Node.js 18 LTS
    curl -fsSL https://deb.nodesource.com/setup_18.x | bash -
    apt install -y nodejs

    # Verificar instala√ß√£o
    log_success "Node.js instalado: $(node --version)"
    log_success "npm instalado: $(npm --version)"
}

# Fun√ß√£o para clonar projeto
clone_project() {
    log_title "CLONANDO PROJETO"
    
    # Remover diret√≥rio se existir
    if [ -d "$PROJECT_DIR" ]; then
        log_warning "Removendo projeto existente..."
        rm -rf "$PROJECT_DIR"
    fi

    # Criar diret√≥rio
    mkdir -p "$PROJECT_DIR"
    
    # Clonar reposit√≥rio
    log_info "Clonando reposit√≥rio..."
    git clone "$GITHUB_REPO" "$PROJECT_DIR"
    
    # Configurar permiss√µes
    chown -R www-data:www-data "$PROJECT_DIR"
    chmod -R 755 "$PROJECT_DIR"
    
    log_success "Projeto clonado em $PROJECT_DIR"
}

# Fun√ß√£o para configurar projeto
setup_project() {
    log_title "CONFIGURANDO PROJETO"
    
    cd "$PROJECT_DIR"
    
    # Instalar depend√™ncias
    log_info "Instalando depend√™ncias Node.js..."
    sudo -u www-data npm ci --production=false
    
    # Criar arquivo .env
    log_info "Criando arquivo .env..."
    cat > .env << EOF
NODE_ENV=production
PORT=3001
ADMIN_PORT=3001
GITHUB_WEBHOOK_SECRET=$WEBHOOK_SECRET
DOMAIN=$DOMAIN
EMAIL=$EMAIL
EOF
    
    # Build do projeto
    log_info "Fazendo build do projeto..."
    sudo -u www-data npm run build
    
    # Configurar Git
    sudo -u www-data git config user.name "Auto Deploy"
    sudo -u www-data git config user.email "$EMAIL"
    sudo -u www-data git config --global --add safe.directory "$PROJECT_DIR"
    
    chown -R www-data:www-data "$PROJECT_DIR"
    
    log_success "Projeto configurado"
}

# Fun√ß√£o para criar script de auto-deploy
create_autodeploy_script() {
    log_title "CRIANDO SCRIPT DE AUTO-DEPLOY"
    
    cat > "$PROJECT_DIR/auto-deploy.sh" << 'EOF'
#!/bin/bash

# Script de Auto-Deploy
set -e

cd /var/www/siqueira-campos

echo "üöÄ Auto-deploy iniciado: $(date)" | tee -a /var/log/siqueira-deploy.log

# Backup
echo "üì¶ Criando backup..." | tee -a /var/log/siqueira-deploy.log
tar -czf "/tmp/backup-$(date +%Y%m%d-%H%M).tar.gz" . 2>/dev/null || echo "Backup falhou"

# Pull mudan√ßas
echo "üì• Baixando mudan√ßas..." | tee -a /var/log/siqueira-deploy.log
sudo -u www-data git fetch origin main
sudo -u www-data git reset --hard origin/main

# Instalar depend√™ncias
echo "üì¶ Instalando depend√™ncias..." | tee -a /var/log/siqueira-deploy.log
sudo -u www-data npm ci --production=false

# Build
echo "üèóÔ∏è Fazendo build..." | tee -a /var/log/siqueira-deploy.log
sudo -u www-data npm run build

# Restart servi√ßos
echo "üîÑ Reiniciando servi√ßos..." | tee -a /var/log/siqueira-deploy.log
systemctl restart siqueira-campos
systemctl reload nginx

echo "‚úÖ Auto-deploy conclu√≠do: $(date)" | tee -a /var/log/siqueira-deploy.log
EOF

    chmod +x "$PROJECT_DIR/auto-deploy.sh"
    chown www-data:www-data "$PROJECT_DIR/auto-deploy.sh"
    
    log_success "Script de auto-deploy criado"
}

# Fun√ß√£o para configurar Nginx
configure_nginx() {
    log_title "CONFIGURANDO NGINX"
    
    # Remover configura√ß√£o padr√£o
    rm -f /etc/nginx/sites-enabled/default
    
    # Criar configura√ß√£o do site
    cat > "$NGINX_CONFIG" << EOF
# Siqueira Campos Im√≥veis - Configura√ß√£o Nginx
# Redirect WWW to non-WWW
server {
    listen 80;
    listen [::]:80;
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    
    server_name www.$DOMAIN *.www.$DOMAIN;
    
    # SSL certificates
    ssl_certificate /etc/letsencrypt/live/$DOMAIN/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/$DOMAIN/privkey.pem;
    
    # Redirect preservando protocolo
    return 301 \$scheme://$DOMAIN\$request_uri;
}

# Main server block
server {
    listen 80;
    listen [::]:80;
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    
    server_name $DOMAIN;
    root $PROJECT_DIR/dist;
    index index.html;
    
    # SSL certificates
    ssl_certificate /etc/letsencrypt/live/$DOMAIN/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/$DOMAIN/privkey.pem;
    
    # SSL security
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers off;
    ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256;
    
    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "no-referrer-when-downgrade" always;
    
    # Mobile optimizations
    add_header Cache-Control "public, max-age=300" always;
    add_header X-Mobile-Optimized "true" always;
    
    # Gzip compression
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;
    
    # Rate limiting
    limit_req_zone \$binary_remote_addr zone=api:10m rate=10r/s;
    limit_req_zone \$binary_remote_addr zone=general:10m rate=30r/s;
    
    # API proxy
    location /api/ {
        limit_req zone=api burst=20 nodelay;
        
        proxy_pass http://127.0.0.1:3001;
        proxy_http_version 1.1;
        proxy_set_header Upgrade \$http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
        proxy_cache_bypass \$http_upgrade;
        
        # Timeouts para mobile
        proxy_connect_timeout 10s;
        proxy_send_timeout 10s;
        proxy_read_timeout 10s;
    }
    
    # Static files
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
    
    # SPA fallback
    location / {
        limit_req zone=general burst=50 nodelay;
        try_files \$uri \$uri/ /index.html;
    }
    
    # Health check
    location /health {
        access_log off;
        return 200 "OK";
        add_header Content-Type text/plain;
    }
    
    # Error pages
    error_page 502 503 504 /50x.html;
    location = /50x.html {
        root /usr/share/nginx/html;
    }
}
EOF
    
    # Habilitar site
    ln -sf "$NGINX_CONFIG" "$NGINX_ENABLED"
    
    # Testar configura√ß√£o
    nginx -t
    
    log_success "Nginx configurado"
}

# Fun√ß√£o para configurar SSL
configure_ssl() {
    log_title "CONFIGURANDO SSL"
    
    # Obter certificado SSL
    log_info "Obtendo certificado SSL..."
    certbot --nginx -d "$DOMAIN" -d "www.$DOMAIN" --email "$EMAIL" --agree-tos --non-interactive --redirect
    
    # Configurar renova√ß√£o autom√°tica
    echo "0 12 * * * /usr/bin/certbot renew --quiet" | crontab -
    
    log_success "SSL configurado e renova√ß√£o autom√°tica ativada"
}

# Fun√ß√£o para criar servi√ßo systemd
create_systemd_service() {
    log_title "CRIANDO SERVI√áO SYSTEMD"
    
    cat > "/etc/systemd/system/$SERVICE_NAME.service" << EOF
[Unit]
Description=Siqueira Campos Im√≥veis - Node.js Application
After=network.target
Wants=network.target

[Service]
Type=simple
User=www-data
Group=www-data
WorkingDirectory=$PROJECT_DIR
Environment=NODE_ENV=production
Environment=PORT=3001
Environment=GITHUB_WEBHOOK_SECRET=$WEBHOOK_SECRET
ExecStart=/usr/bin/node server/start.js
ExecReload=/bin/kill -USR1 \$MAINPID
Restart=always
RestartSec=10
StandardOutput=syslog
StandardError=syslog
SyslogIdentifier=siqueira-campos

# Security
NoNewPrivileges=true
PrivateTmp=true
ProtectSystem=strict
ProtectHome=true
ReadWritePaths=$PROJECT_DIR
ReadWritePaths=/tmp
ReadWritePaths=/var/log

[Install]
WantedBy=multi-user.target
EOF
    
    # Recarregar systemd e habilitar servi√ßo
    systemctl daemon-reload
    systemctl enable "$SERVICE_NAME"
    
    log_success "Servi√ßo systemd criado e habilitado"
}

# Fun√ß√£o para configurar firewall
configure_firewall() {
    log_title "CONFIGURANDO FIREWALL"
    
    # Configurar UFW
    ufw --force reset
    ufw default deny incoming
    ufw default allow outgoing
    
    # Portas essenciais
    ufw allow ssh
    ufw allow 80/tcp
    ufw allow 443/tcp
    
    # Habilitar firewall
    ufw --force enable
    
    log_success "Firewall configurado"
}

# Fun√ß√£o para configurar monitoramento
configure_monitoring() {
    log_title "CONFIGURANDO MONITORAMENTO"
    
    # Script de monitoramento
    cat > "/usr/local/bin/monitor-siqueira.sh" << 'EOF'
#!/bin/bash

# Monitor do sistema
SERVICE="siqueira-campos"
DOMAIN="__DOMAIN__"
EMAIL="__EMAIL__"
LOG_FILE="/var/log/siqueira-monitor.log"

check_service() {
    if ! systemctl is-active --quiet $SERVICE; then
        echo "$(date): Servi√ßo $SERVICE est√° down, reiniciando..." >> $LOG_FILE
        systemctl restart $SERVICE
    fi
}

check_website() {
    if ! curl -f "https://$DOMAIN/api/ping" >/dev/null 2>&1; then
        echo "$(date): Website n√£o responde, reiniciando servi√ßos..." >> $LOG_FILE
        systemctl restart $SERVICE
        systemctl reload nginx
    fi
}

check_ssl() {
    if ! openssl s_client -connect $DOMAIN:443 -servername $DOMAIN </dev/null 2>/dev/null | openssl x509 -checkend 604800 -noout; then
        echo "$(date): SSL expira em 7 dias, renovando..." >> $LOG_FILE
        certbot renew --quiet
    fi
}

check_service
check_website
check_ssl

echo "$(date): Monitor executado com sucesso" >> $LOG_FILE
EOF
    
    # Substituir vari√°veis
    sed -i "s/__DOMAIN__/$DOMAIN/g" /usr/local/bin/monitor-siqueira.sh
    sed -i "s/__EMAIL__/$EMAIL/g" /usr/local/bin/monitor-siqueira.sh
    
    chmod +x /usr/local/bin/monitor-siqueira.sh
    
    # Adicionar ao cron
    echo "*/5 * * * * /usr/local/bin/monitor-siqueira.sh" | crontab -
    
    log_success "Monitoramento configurado (executa a cada 5 minutos)"
}

# Fun√ß√£o para configurar logrotate
configure_logrotate() {
    log_title "CONFIGURANDO ROTA√á√ÉO DE LOGS"
    
    cat > "/etc/logrotate.d/siqueira-campos" << EOF
/var/log/siqueira-*.log {
    daily
    missingok
    rotate 14
    compress
    delaycompress
    notifempty
    create 644 www-data www-data
    postrotate
        systemctl reload $SERVICE_NAME
    endscript
}
EOF
    
    log_success "Rota√ß√£o de logs configurada"
}

# Fun√ß√£o principal de deploy
deploy_application() {
    log_title "FAZENDO DEPLOY DA APLICA√á√ÉO"
    
    cd "$PROJECT_DIR"
    
    # Parar servi√ßo se estiver rodando
    systemctl stop "$SERVICE_NAME" 2>/dev/null || true
    
    # Build final
    log_info "Build final da aplica√ß√£o..."
    sudo -u www-data npm run build
    
    # Iniciar servi√ßos
    log_info "Iniciando servi√ßos..."
    systemctl start "$SERVICE_NAME"
    systemctl reload nginx
    
    # Aguardar inicializa√ß√£o
    sleep 10
    
    log_success "Aplica√ß√£o deployada"
}

# Fun√ß√£o para testar tudo
test_deployment() {
    log_title "TESTANDO DEPLOYMENT"
    
    local tests_passed=0
    local total_tests=6
    
    # Teste 1: Servi√ßo rodando
    if systemctl is-active --quiet "$SERVICE_NAME"; then
        log_success "‚úì Servi√ßo $SERVICE_NAME est√° rodando"
        ((tests_passed++))
    else
        log_error "‚úó Servi√ßo $SERVICE_NAME n√£o est√° rodando"
    fi
    
    # Teste 2: Nginx rodando
    if systemctl is-active --quiet nginx; then
        log_success "‚úì Nginx est√° rodando"
        ((tests_passed++))
    else
        log_error "‚úó Nginx n√£o est√° rodando"
    fi
    
    # Teste 3: API respondendo
    if curl -f "http://localhost:3001/api/ping" >/dev/null 2>&1; then
        log_success "‚úì API respondendo na porta 3001"
        ((tests_passed++))
    else
        log_error "‚úó API n√£o est√° respondendo"
    fi
    
    # Teste 4: Website HTTP
    if curl -f "http://$DOMAIN" >/dev/null 2>&1; then
        log_success "‚úì Website HTTP funcionando"
        ((tests_passed++))
    else
        log_warning "‚ö† Website HTTP com problema"
    fi
    
    # Teste 5: Website HTTPS
    if curl -f "https://$DOMAIN" >/dev/null 2>&1; then
        log_success "‚úì Website HTTPS funcionando"
        ((tests_passed++))
    else
        log_warning "‚ö† Website HTTPS com problema"
    fi
    
    # Teste 6: Redirect WWW
    if curl -s -o /dev/null -w "%{http_code}" "http://www.$DOMAIN" | grep -q "301"; then
        log_success "‚úì Redirect WWW funcionando"
        ((tests_passed++))
    else
        log_warning "‚ö† Redirect WWW com problema"
    fi
    
    echo ""
    if [ $tests_passed -eq $total_tests ]; then
        log_success "üéâ TODOS OS TESTES PASSARAM ($tests_passed/$total_tests)"
    elif [ $tests_passed -ge 4 ]; then
        log_warning "‚ö†Ô∏è A MAIORIA DOS TESTES PASSOU ($tests_passed/$total_tests)"
    else
        log_error "‚ùå MUITOS TESTES FALHARAM ($tests_passed/$total_tests)"
    fi
}

# Fun√ß√£o de finaliza√ß√£o
show_final_info() {
    log_title "DEPLOYMENT CONCLU√çDO!"
    
    echo ""
    echo -e "${GREEN}‚ïî‚ïê‚ïê‚ïêÔøΩÔøΩÔøΩ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
    echo -e "${GREEN}‚ïë                    SUCESSO! üéâ                               ‚ïë${NC}"
    echo -e "${GREEN}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"
    echo ""
    
    log_success "URLs do seu site:"
    echo "üåê Principal: https://$DOMAIN"
    echo "üåê WWW: https://www.$DOMAIN (redireciona)"
    echo "üîó API: https://$DOMAIN/api/ping"
    echo "‚ù§Ô∏è Health: https://$DOMAIN/health"
    echo ""
    
    log_success "Configura√ß√£o do GitHub Webhook:"
    echo "ü™ù URL: https://$DOMAIN/api/webhook/github"
    echo "üîê Secret: $WEBHOOK_SECRET"
    echo "üìù Eventos: push (branch main apenas)"
    echo ""
    
    log_success "Monitoramento:"
    echo "üìä Logs: journalctl -u $SERVICE_NAME -f"
    echo "üìä Monitor: tail -f /var/log/siqueira-monitor.log"
    echo "üìä Deploy: tail -f /var/log/siqueira-deploy.log"
    echo "üìä Nginx: tail -f /var/log/nginx/access.log"
    echo ""
    
    log_success "Comandos √∫teis:"
    echo "üîÑ Restart: systemctl restart $SERVICE_NAME"
    echo "üìä Status: systemctl status $SERVICE_NAME"
    echo "üîß Deploy manual: $PROJECT_DIR/auto-deploy.sh"
    echo "üîí Renovar SSL: certbot renew"
    echo ""
    
    log_warning "Pr√≥ximos passos:"
    echo "1. Configure o webhook no GitHub:"
    echo "   https://github.com/Nakahh/site-jurez-2.0/settings/hooks"
    echo "2. Teste fazendo um push no reposit√≥rio"
    echo "3. Verifique se o deploy autom√°tico funciona"
    echo ""
    
    log_success "Sistema 100% funcional e monitorado! üöÄ"
}

# EXECU√á√ÉO PRINCIPAL
main() {
    log_title "INICIANDO SETUP COMPLETO"
    
    # Instalar tudo
    install_packages
    install_docker
    install_nodejs
    
    # Configurar projeto
    clone_project
    setup_project
    create_autodeploy_script
    
    # Configurar servidor
    configure_nginx
    create_systemd_service
    configure_firewall
    configure_monitoring
    configure_logrotate
    
    # Deploy
    deploy_application
    
    # SSL (por √∫ltimo pois precisa do site funcionando)
    configure_ssl
    
    # Testar
    test_deployment
    
    # Finalizar
    show_final_info
}

# Executar fun√ß√£o principal
main "$@"
